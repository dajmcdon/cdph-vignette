<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 3 Examples of Preprocessing and Models | Vignette on Delphi Tooling for CDPH</title>
<meta name="author" content="Logan Brooks, Daniel J. McDonald, and Ryan J. Tibshirani">
<meta name="description" content="3.1 Introduction The epipredict package utilizes the tidymodels framework, namely {recipes} for dplyr-like pipeable sequences of feature engineering and {parsnip} for a unified interface to a...">
<meta name="generator" content="bookdown 0.33 with bs4_book()">
<meta property="og:title" content="Chapter 3 Examples of Preprocessing and Models | Vignette on Delphi Tooling for CDPH">
<meta property="og:type" content="book">
<meta property="og:url" content="https://delphi.cmu.edu/examples-of-preprocessing-and-models.html">
<meta property="og:description" content="3.1 Introduction The epipredict package utilizes the tidymodels framework, namely {recipes} for dplyr-like pipeable sequences of feature engineering and {parsnip} for a unified interface to a...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 3 Examples of Preprocessing and Models | Vignette on Delphi Tooling for CDPH">
<meta name="twitter:description" content="3.1 Introduction The epipredict package utilizes the tidymodels framework, namely {recipes} for dplyr-like pipeable sequences of feature engineering and {parsnip} for a unified interface to a...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Vignette on Delphi Tooling for CDPH</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled"><li><a class="" href="index.html"><span class="header-section-number">Chapter 3</span> Examples of Preprocessing and Models</a></li></ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/dajmcdon/cdph-vignette">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="examples-of-preprocessing-and-models" class="section level1" number="3">
<h1>
<span class="header-section-number">3</span> Examples of Preprocessing and Models<a class="anchor" aria-label="anchor" href="#examples-of-preprocessing-and-models"><i class="fas fa-link"></i></a>
</h1>
<div id="introduction" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction"><i class="fas fa-link"></i></a>
</h2>
<p>The <code>epipredict</code> package utilizes the <code>tidymodels</code> framework, namely
<a href="https://recipes.tidymodels.org/"><code>{recipes}</code></a> for
<a href="https://dplyr.tidyverse.org/">dplyr</a>-like pipeable sequences
of feature engineering and <a href="https://parsnip.tidymodels.org/"><code>{parsnip}</code></a> for a
unified interface to a range of models.</p>
<p><code>epipredict</code> has additional customized feature engineering and preprocessing
steps, such as <code><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_shift.html">step_epi_lag()</a></code>, <code><a href="https://cmu-delphi.github.io/epipredict/reference/step_population_scaling.html">step_population_scaling()</a></code>,
<code><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_naomit.html">step_epi_naomit()</a></code>. They can be used along with
steps from the <a href="https://github.com/tidymodels/recipes">recipes</a> package for more feature engineering.</p>
<p>In this vignette, we will illustrate some examples of how to use <code>epipredict</code>
with <code>recipes</code> and <code>parsnip</code> for different purposes of epidemiological forecasting.
We will focus on basic autoregressive models, in which COVID cases and
deaths in the near future are predicted using a linear combination of cases and
deaths in the near past.</p>
<p>The remaining vignette will be split into three sections. The first section, we
will use a Poisson regression to predict death counts. In the second section,
we will use a linear regression to predict death rates. Last but not least, we
will create a classification model for hotspot predictions.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epidatr">epidatr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epiprocess/">epiprocess</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epipredict/">epipredict</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/recipes">recipes</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/parsnip">parsnip</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/workflows">workflows</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/poissonreg">poissonreg</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div id="poisson-regression" class="section level2" number="3.2">
<h2>
<span class="header-section-number">3.2</span> Poisson Regression<a class="anchor" aria-label="anchor" href="#poisson-regression"><i class="fas fa-link"></i></a>
</h2>
<p>During COVID-19, the U.S. Centers for Disease Control and Prevention (CDC) collected
models
and forecasts to characterize the state of an outbreak and its course. They use
it to inform public health decision makers on potential consequences of
deploying control measures.</p>
<p>One of the outcomes that the CDC forecasts is <a href="https://www.cdc.gov/coronavirus/2019-ncov/science/forecasting/forecasting-us.html">death counts from COVID-19</a>.
Although there are many state-of-the-art models, we choose to use Poisson
regression, the textbook example for modeling count data, as an illustration
for using the <code>epipredict</code> package with other existing tidymodels packages.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ca"</span>, <span class="st">"fl"</span>, <span class="st">"tx"</span>, <span class="st">"ny"</span>, <span class="st">"nj"</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/covidcast.html">covidcast</a></span><span class="op">(</span></span>
<span>  data_source <span class="op">=</span> <span class="st">"jhu-csse"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"confirmed_incidence_num"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/epirange.html">epirange</a></span><span class="op">(</span><span class="fl">20210604</span>, <span class="fl">20211231</span><span class="op">)</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="va">geos</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/fetch_tbl.html">fetch_tbl</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, cases <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/covidcast.html">covidcast</a></span><span class="op">(</span></span>
<span>  data_source <span class="op">=</span> <span class="st">"jhu-csse"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"deaths_incidence_num"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/epirange.html">epirange</a></span><span class="op">(</span><span class="fl">20210604</span>, <span class="fl">20211231</span><span class="op">)</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="va">geos</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/fetch_tbl.html">fetch_tbl</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, deaths <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="va">counts_subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"time_value"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/as_epi_df.html">as_epi_df</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The <code>counts_subset</code> dataset comes from the <code>epidatr</code> package, and
contains the number of confirmed cases and deaths from June 4, 2021 to
Dec 31, 2021 in some U.S. states.</p>
<p>We wish to predict the 7-day ahead death counts with lagged cases and deaths.
Furthermore, we will let each state be a dummy variable. Using differential
intercept coefficients, we can allow for an intercept shift between states.</p>
One possible model takes the form
<span class="math display">\[\begin{aligned}
\log\left( \mu_{t+7} \right) &amp;{}= \beta_0 + \delta_1 s_{\text{state}_1} +
\delta_2 s_{\text{state}_2} + \cdots +  \nonumber \\ &amp;\quad\beta_1 \text{deaths}_{t} +
\beta_2 \text{deaths}_{t-7}  + \beta_3 \text{cases}_{t} +
\beta_4 \text{cases}_{t-7},
\end{aligned}\]</span>
<p>where <span class="math inline">\(\mu_{t+7} = \mathbb{E}(\text{deaths}_{t+7})\)</span>, and <span class="math inline">\(\text{deaths}_{t+7}\)</span>
is assumed to follow a Poisson distribution with mean <span class="math inline">\(\mu_{t+7}\)</span>;
<span class="math inline">\(s_{\text{state}}\)</span> are dummy variables for each state and take values of either
0 or 1.</p>
<p>Preprocessing steps will be performed to prepare the
data for model fitting. But before diving into them, it will be helpful to understand what <code>roles</code> are in the <code>recipes</code> framework.</p>
<hr>
<div id="aside-on-recipes" class="section level4 unnumbered">
<h4>Aside on <code>recipes</code><a class="anchor" aria-label="anchor" href="#aside-on-recipes"><i class="fas fa-link"></i></a>
</h4>
<p><code>recipes</code> can assign one or more roles to each column in the data. The roles
are not restricted to a predefined set; they can be anything.
For most conventional situations, they are typically “predictor” and/or
“outcome”. Additional roles enable targeted <code>step_*()</code> operations on specific
variables or groups of variables.</p>
<p>In our case, the role <code>predictor</code> is given to explanatory variables on the
right-hand side of the model (in the equation above).
The role <code>outcome</code> is the response variable
that we wish to predict. <code>geo_value</code> and <code>time_value</code> are predefined roles
that are unique to the <code>epipredict</code> package. Since we work with <code>epi_df</code>
objects, all datasets should have <code>geo_value</code> and <code>time_value</code> passed through
automatically with these two roles assigned to the appropriate columns in the data.</p>
<p>The <code>recipes</code> package also allows <a href="https://recipes.tidymodels.org/reference/roles.html">manual alterations of roles</a>
in bulk. There are a few handy functions that can be used together to help us
manipulate variable roles easily.</p>
<blockquote>
<p><code><a href="https://recipes.tidymodels.org/reference/roles.html">update_role()</a></code> alters an existing role in the recipe or assigns an initial role
to variables that do not yet have a declared role.</p>
<p><code><a href="https://recipes.tidymodels.org/reference/roles.html">add_role()</a></code> adds an additional role to variables that already have a role in
the recipe, without overwriting old roles.</p>
<p><code><a href="https://recipes.tidymodels.org/reference/roles.html">remove_role()</a></code> eliminates a single existing role in the recipe.</p>
</blockquote>
</div>
<div id="end-aside" class="section level4 unnumbered">
<h4>End aside<a class="anchor" aria-label="anchor" href="#end-aside"><i class="fas fa-link"></i></a>
</h4>
<hr>
<p>Notice in the following preprocessing steps, we used <code><a href="https://recipes.tidymodels.org/reference/roles.html">add_role()</a></code> on
<code>geo_value_factor</code> since, currently, the default role for it is <code>raw</code>, but
we would like to reuse this variable as a <code>predictor</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts_subset</span> <span class="op">&lt;-</span> <span class="va">counts_subset</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>geo_value_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/as_epi_df.html">as_epi_df</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">counts_subset</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">counts_subset</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html">add_role</a></span><span class="op">(</span><span class="va">geo_value_factor</span>, new_role <span class="op">=</span> <span class="st">"predictor"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html">step_dummy</a></span><span class="op">(</span><span class="va">geo_value_factor</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Occasionally, data reporting errors / corrections result in negative</span></span>
<span>  <span class="co">## cases / deaths</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html">step_mutate</a></span><span class="op">(</span>cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">cases</span>, <span class="fl">0</span><span class="op">)</span>, deaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">deaths</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">cases</span>, <span class="va">deaths</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">deaths</span>, ahead <span class="op">=</span> <span class="fl">7</span>, role <span class="op">=</span> <span class="st">"outcome"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_naomit.html">step_epi_naomit</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>After specifying the preprocessing steps, we will use the <code>parsnip</code> package for
modeling and producing the prediction for death count, 7 days after the
latest available date in the dataset.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">latest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/get_test_data.html">get_test_data</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">counts_subset</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/poisson_reg.html">poisson_reg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="va">counts_subset</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">wf</span>, <span class="va">latest</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.pred</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 5 x 3 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-04-04 16:26:23</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; # A tibble: 5 × 3</span></span>
<span><span class="co">#&gt;   geo_value time_value .pred</span></span>
<span><span class="co">#&gt; * &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 ca        2021-12-31 108. </span></span>
<span><span class="co">#&gt; 2 fl        2021-12-31 270. </span></span>
<span><span class="co">#&gt; 3 nj        2021-12-31  22.5</span></span>
<span><span class="co">#&gt; 4 ny        2021-12-31  94.8</span></span>
<span><span class="co">#&gt; 5 tx        2021-12-31  91.0</span></span></code></pre></div>
<p>Note that the <code>time_value</code> corresponds to the last available date in the
training set, <strong>NOT</strong> to the target date of the forecast
(2022-01-07).</p>
<p>Let’s take a look at the fit:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html">extract_fit_engine</a></span><span class="op">(</span><span class="va">wf</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:  stats::glm(formula = ..y ~ ., family = stats::poisson, data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;         (Intercept)  geo_value_factor_fl  </span></span>
<span><span class="co">#&gt;           3.970e+00           -1.487e-01  </span></span>
<span><span class="co">#&gt; geo_value_factor_nj  geo_value_factor_ny  </span></span>
<span><span class="co">#&gt;          -1.425e+00           -6.865e-01  </span></span>
<span><span class="co">#&gt; geo_value_factor_tx          lag_0_cases  </span></span>
<span><span class="co">#&gt;           3.025e-01            1.339e-05  </span></span>
<span><span class="co">#&gt;         lag_7_cases         lag_0_deaths  </span></span>
<span><span class="co">#&gt;           1.717e-06            1.731e-03  </span></span>
<span><span class="co">#&gt;        lag_7_deaths  </span></span>
<span><span class="co">#&gt;           8.566e-04  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Degrees of Freedom: 984 Total (i.e. Null);  976 Residual</span></span>
<span><span class="co">#&gt; Null Deviance:       139600 </span></span>
<span><span class="co">#&gt; Residual Deviance: 58110     AIC: 62710</span></span></code></pre></div>
<p>Alternative forms of Poisson regression or particular computational approaches
can be applied via arguments to <code><a href="https://parsnip.tidymodels.org/reference/poisson_reg.html">parsnip::poisson_reg()</a></code> for some common
settings, and by using <code><a href="https://parsnip.tidymodels.org/reference/set_engine.html">parsnip::set_engine()</a></code> to use a specific Poisson
regression engine and to provide additional engine-specific customization.</p>
</div>
</div>
<div id="linear-regression" class="section level2" number="3.3">
<h2>
<span class="header-section-number">3.3</span> Linear Regression<a class="anchor" aria-label="anchor" href="#linear-regression"><i class="fas fa-link"></i></a>
</h2>
<p>For COVID-19, the CDC required submission of case and death count predictions.
However, the Delphi Group preferred to train on rate data instead, because it
puts different locations on a similar scale (eliminating the need for location-specific intercepts).
We can use a linear regression to predict the death rates and use state
population data to scale the rates to counts.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;We could continue with the Poisson model, but we’ll switch to the Gaussian likelihood just for simplicity.&lt;/p&gt;"><sup>1</sup></a> We will do so using
<code><a href="https://cmu-delphi.github.io/epipredict/reference/layer_population_scaling.html">layer_population_scaling()</a></code> from the <code>epipredict</code> package. (We could also use
<code><a href="https://cmu-delphi.github.io/epipredict/reference/step_population_scaling.html">step_population_scaling()</a></code> from the <code>epipredict</code> package to prepare rate data
from count data in the preprocessing recipe.)</p>
<p>Additionally, when forecasts are submitted, prediction intervals should be
provided along with the point estimates. This can be obtained via postprocessing
using
<code><a href="https://cmu-delphi.github.io/epipredict/reference/layer_residual_quantiles.html">layer_residual_quantiles()</a></code>. It is worth pointing out, however, that
<code><a href="https://cmu-delphi.github.io/epipredict/reference/layer_residual_quantiles.html">layer_residual_quantiles()</a></code> should be used before population scaling or else
the transformation will make the results uninterpretable.</p>
<p>We wish, now, to predict the 7-day ahead death counts with lagged case rates and death
rates, along with some extra behaviourial predictors. Namely, we will use survey data
from <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/fb-survey.html#behavior-indicators">COVID-19 Trends and Impact Survey</a>.</p>
<p>The survey data provides the estimated percentage of people who wore a mask for
most or all of the time while in public in the past 7 days and the estimated
percentage of respondents who reported that all or most people they encountered
in public in the past 7 days maintained a distance of at least 6 feet.</p>
<p>State-wise population data from the 2019 U.S. Census is included in this package
and will be used in <code><a href="https://cmu-delphi.github.io/epipredict/reference/layer_population_scaling.html">layer_population_scaling()</a></code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">behav_ind_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/covidcast.html">covidcast</a></span><span class="op">(</span></span>
<span>  data_source <span class="op">=</span> <span class="st">"fb-survey"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"smoothed_wwearing_mask_7d"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/epirange.html">epirange</a></span><span class="op">(</span><span class="fl">20210604</span>, <span class="fl">20211231</span><span class="op">)</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="va">geos</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/fetch_tbl.html">fetch_tbl</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, masking <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="va">behav_ind_distancing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/covidcast.html">covidcast</a></span><span class="op">(</span></span>
<span>  data_source <span class="op">=</span> <span class="st">"fb-survey"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"smoothed_wothers_distanced_public"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/epirange.html">epirange</a></span><span class="op">(</span><span class="fl">20210604</span>, <span class="fl">20211231</span><span class="op">)</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="va">geos</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/fetch_tbl.html">fetch_tbl</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, distancing <span class="op">=</span> <span class="va">value</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">pop_dat</span> <span class="op">&lt;-</span> <span class="va">state_census</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">abbr</span>, <span class="va">pop</span><span class="op">)</span></span>
<span></span>
<span><span class="va">behav_ind</span> <span class="op">&lt;-</span> <span class="va">behav_ind_mask</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">behav_ind_distancing</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"time_value"</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p>Rather than using raw mask-wearing / social-distancing metrics, for the sake
of illustration, we’ll convert both into categorical predictors.</p>
<div class="inline-figure"><img src="02-preprocessing-and-models_files/figure-html/unnamed-chunk-6-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>We will take a subset of death rate and case rate data from the built-in dataset
<code>case_death_rate_subset</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jhu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>  <span class="va">case_death_rate_subset</span>,</span>
<span>  <span class="va">time_value</span> <span class="op">&gt;=</span> <span class="st">"2021-06-04"</span>, </span>
<span>  <span class="va">time_value</span> <span class="op">&lt;=</span> <span class="st">"2021-12-31"</span>,</span>
<span>  <span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ca"</span>,<span class="st">"fl"</span>,<span class="st">"tx"</span>,<span class="st">"ny"</span>,<span class="st">"nj"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Preprocessing steps will again rely on functions from the <code>epipredict</code> package as well
as the <code>recipes</code> package.
There are also many functions in the <code>recipes</code> package that allow for
<a href="https://recipes.tidymodels.org/reference/#step-functions-individual-transformations">scalar transformations</a>,
such as log transformations and data centering. In our case, we will
center the numerical predictors to allow for a more meaningful interpretation of the
intercept.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jhu</span> <span class="op">&lt;-</span> <span class="va">jhu</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>geo_value_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">behav_ind</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"time_value"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/as_epi_df.html">as_epi_df</a></span><span class="op">(</span><span class="op">)</span></span>
<span>            </span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">jhu</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html">add_role</a></span><span class="op">(</span><span class="va">geo_value_factor</span>, new_role <span class="op">=</span> <span class="st">"predictor"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html">step_dummy</a></span><span class="op">(</span><span class="va">geo_value_factor</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">case_rate</span>, <span class="va">death_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html">step_mutate</a></span><span class="op">(</span>masking <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/cut_interval.html">cut_number</a></span><span class="op">(</span><span class="va">masking</span>, <span class="fl">5</span><span class="op">)</span>, </span>
<span>              distancing <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/cut_interval.html">cut_number</a></span><span class="op">(</span><span class="va">distancing</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">death_rate</span>, ahead <span class="op">=</span> <span class="fl">7</span>, role <span class="op">=</span> <span class="st">"outcome"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_center.html">step_center</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"lag"</span><span class="op">)</span>, role <span class="op">=</span> <span class="st">"predictor"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_naomit.html">step_epi_naomit</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>As a sanity check we can examine the structure of the training data:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html">bake</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html">prep</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">jhu</span><span class="op">)</span>, <span class="va">jhu</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 6</span></span>
<span><span class="co">#&gt; Columns: 17</span></span>
<span><span class="co">#&gt; $ time_value          &lt;date&gt; 2021-07-22, 2021-07-25, 2021-…</span></span>
<span><span class="co">#&gt; $ geo_value           &lt;chr&gt; "tx", "ny", "ca", "ca", "fl", …</span></span>
<span><span class="co">#&gt; $ case_rate           &lt;dbl&gt; 14.282426, 6.909115, 9.655756,…</span></span>
<span><span class="co">#&gt; $ death_rate          &lt;dbl&gt; 0.0836880, 0.0273350, 0.201758…</span></span>
<span><span class="co">#&gt; $ masking             &lt;fct&gt; "[42.7,52.8]", "[42.7,52.8]", …</span></span>
<span><span class="co">#&gt; $ distancing          &lt;fct&gt; "(18.4,19.8]", "(18.4,19.8]", …</span></span>
<span><span class="co">#&gt; $ geo_value_factor_fl &lt;dbl&gt; 0, 0, 0, 0, 1, 0</span></span>
<span><span class="co">#&gt; $ geo_value_factor_nj &lt;dbl&gt; 0, 0, 0, 0, 0, 0</span></span>
<span><span class="co">#&gt; $ geo_value_factor_ny &lt;dbl&gt; 0, 1, 0, 0, 0, 1</span></span>
<span><span class="co">#&gt; $ geo_value_factor_tx &lt;dbl&gt; 1, 0, 0, 0, 0, 0</span></span>
<span><span class="co">#&gt; $ lag_0_case_rate     &lt;dbl&gt; -12.65924, -20.03255, -17.2859…</span></span>
<span><span class="co">#&gt; $ lag_7_case_rate     &lt;dbl&gt; -18.420571, -22.365630, -12.43…</span></span>
<span><span class="co">#&gt; $ lag_14_case_rate    &lt;dbl&gt; -21.587091, -24.008687, -13.60…</span></span>
<span><span class="co">#&gt; $ lag_0_death_rate    &lt;dbl&gt; -0.1981856, -0.2545386, -0.080…</span></span>
<span><span class="co">#&gt; $ lag_7_death_rate    &lt;dbl&gt; -0.1865082, -0.2523222, -0.068…</span></span>
<span><span class="co">#&gt; $ lag_14_death_rate   &lt;dbl&gt; -0.2054840, -0.2567549, -0.065…</span></span>
<span><span class="co">#&gt; $ ahead_7_death_rate  &lt;dbl&gt; 0.1221261, 0.0347229, 0.206839…</span></span></code></pre></div>
<p>Before directly predicting the results, we need to add postprocessing layers to
obtain the death counts instead of death rates. Note that the rates used so
far are “per 100K people” rather than “per person”. We’ll also use quantile
regression with the <code>quantile_reg</code> engine rather than ordinary least squares
to create median predictions and a 90% prediction interval.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/frosting.html">frosting</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/layer_predict.html">layer_predict</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/layer_add_target_date.html">layer_add_target_date</a></span><span class="op">(</span><span class="st">"2022-01-07"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/layer_threshold.html">layer_threshold</a></span><span class="op">(</span><span class="va">.pred</span>, lower <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/layer_quantile_distn.html">layer_quantile_distn</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/layer_naomit.html">layer_naomit</a></span><span class="op">(</span><span class="va">.pred</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/layer_population_scaling.html">layer_population_scaling</a></span><span class="op">(</span></span>
<span>    <span class="va">.pred</span>, <span class="va">.pred_distn</span>, </span>
<span>    df <span class="op">=</span> <span class="va">pop_dat</span>, </span>
<span>    rate_rescaling <span class="op">=</span> <span class="fl">1e5</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"geo_value"</span> <span class="op">=</span> <span class="st">"abbr"</span><span class="op">)</span>, </span>
<span>    df_pop_col <span class="op">=</span> <span class="st">"pop"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/quantile_reg.html">quantile_reg</a></span><span class="op">(</span>tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.05</span>, <span class="fl">.5</span>, <span class="fl">.95</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="va">jhu</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/add_frosting.html">add_frosting</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span></span>
<span><span class="va">latest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/get_test_data.html">get_test_data</a></span><span class="op">(</span>recipe <span class="op">=</span> <span class="va">r</span>, x <span class="op">=</span> <span class="va">jhu</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">wf</span>, <span class="va">latest</span><span class="op">)</span></span>
<span><span class="va">p</span></span>
<span><span class="co">#&gt; An `epi_df` object, 5 x 7 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2022-05-31 12:08:25</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; # A tibble: 5 × 7</span></span>
<span><span class="co">#&gt;   geo_value time_value               .pred target_date</span></span>
<span><span class="co">#&gt; * &lt;chr&gt;     &lt;date&gt;                  &lt;dist&gt; &lt;date&gt;     </span></span>
<span><span class="co">#&gt; 1 ca        2021-12-31 [0.05, 0.95]&lt;q-rng&gt; 2022-01-07 </span></span>
<span><span class="co">#&gt; 2 fl        2021-12-31 [0.05, 0.95]&lt;q-rng&gt; 2022-01-07 </span></span>
<span><span class="co">#&gt; 3 nj        2021-12-31 [0.05, 0.95]&lt;q-rng&gt; 2022-01-07 </span></span>
<span><span class="co">#&gt; 4 ny        2021-12-31 [0.05, 0.95]&lt;q-rng&gt; 2022-01-07 </span></span>
<span><span class="co">#&gt; 5 tx        2021-12-31 [0.05, 0.95]&lt;q-rng&gt; 2022-01-07 </span></span>
<span><span class="co">#&gt; # ℹ 3 more variables: .pred_distn &lt;dist&gt;,</span></span>
<span><span class="co">#&gt; #   .pred_scaled &lt;dist&gt;, .pred_distn_scaled &lt;dist&gt;</span></span></code></pre></div>
<p>The columns marked <code>*_scaled</code> have been rescaled to the correct units, in this
case <code>deaths</code> rather than deaths per 100K people (these remain in <code>.pred</code>).</p>
<p>To look at the prediction intervals:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">target_date</span>, <span class="va">.pred_scaled</span>, <span class="va">.pred_distn_scaled</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.pred_distn_scaled <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/nested_quantiles.html">nested_quantiles</a></span><span class="op">(</span><span class="va">.pred_distn_scaled</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">.pred_distn_scaled</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">tau</span>, values_from <span class="op">=</span> <span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 5 × 5</span></span>
<span><span class="co">#&gt;   geo_value target_date        .pred_scaled `0.25` `0.75`</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;     &lt;date&gt;                   &lt;dist&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 ca        2022-01-07  [0.05, 0.95]&lt;q-rng&gt;   48.8   94.0</span></span>
<span><span class="co">#&gt; 2 fl        2022-01-07  [0.05, 0.95]&lt;q-rng&gt;   48.4  104. </span></span>
<span><span class="co">#&gt; 3 nj        2022-01-07  [0.05, 0.95]&lt;q-rng&gt;   45.5   68.7</span></span>
<span><span class="co">#&gt; 4 ny        2022-01-07  [0.05, 0.95]&lt;q-rng&gt;  108.   163. </span></span>
<span><span class="co">#&gt; 5 tx        2022-01-07  [0.05, 0.95]&lt;q-rng&gt;   68.6  107.</span></span></code></pre></div>
<p>Last but not least, let’s take a look at the regression fit and check the
coefficients:</p>
<pre><code>#&gt; Call:
#&gt; quantreg::rq(formula = ..y ~ ., tau = ~c(0.05, 0.5, 0.95), data = data, 
#&gt;     na.action = function (object, ...) 
#&gt;     UseMethod("na.omit"), method = "br", model = FALSE)
#&gt; 
#&gt; Coefficients:
#&gt;                        tau= 0.05     tau= 0.50    tau= 0.95
#&gt; (Intercept)          0.210811625  0.2962574475  0.417583265
#&gt; geo_value_factor_fl  0.032085820  0.0482361119  0.171126713
#&gt; geo_value_factor_nj  0.007313762 -0.0033797953 -0.025251865
#&gt; geo_value_factor_ny -0.001489163 -0.0199485947 -0.032635584
#&gt; geo_value_factor_tx  0.029077485  0.0391980273  0.071961515
#&gt; lag_0_case_rate     -0.001636588 -0.0011625693 -0.001430622
#&gt; lag_7_case_rate      0.004700752  0.0057822095  0.006912655
#&gt; lag_14_case_rate     0.001715816  0.0004224753  0.003448733
#&gt; lag_0_death_rate     0.462341754  0.5274192012  0.164856372
#&gt; lag_7_death_rate    -0.007368501  0.1132903956  0.172687438
#&gt; lag_14_death_rate   -0.072500707 -0.0270474349  0.181279299
#&gt; 
#&gt; Degrees of freedom: 950 total; 939 residual</code></pre>
</div>
<div id="classification" class="section level2" number="3.4">
<h2>
<span class="header-section-number">3.4</span> Classification<a class="anchor" aria-label="anchor" href="#classification"><i class="fas fa-link"></i></a>
</h2>
<p>Sometimes it is preferable to create a predictive model for surges or upswings
rather than for raw values. In this case,
the target is to predict if the future will have increased case rates (denoted <code>up</code>),
decreased case rates (<code>down</code>), or flat case rates (<code>flat</code>) relative to the current
level. Such models may be
referred to as “hotspot prediction models”. We will follow the analysis
in <a href="examples-of-preprocessing-and-models.html#references">McDonald, Bien, Green, Hu, et al.</a> but extend the application
to predict three categories instead of two.</p>
<p>Hotspot prediction uses a categorical outcome variable defined in terms of the
relative change of <span class="math inline">\(Y_{\ell, t+a}\)</span> compared to <span class="math inline">\(Y_{\ell, t}\)</span>.
Where <span class="math inline">\(Y_{\ell, t}\)</span> denotes the case rates in location <span class="math inline">\(\ell\)</span> at time <span class="math inline">\(t\)</span>.
We define the response variables as follows:</p>
<p><span class="math display">\[
Z_{\ell, t}=
    \begin{cases}
      \text{up}, &amp; \text{if}\ Y^{\Delta}_{\ell, t} &gt; 0.25 \\
      \text{down}, &amp; \text{if}\  Y^{\Delta}_{\ell, t} &lt; -0.20\\
      \text{flat}, &amp; \text{otherwise}
    \end{cases}
\]</span></p>
<p>where <span class="math inline">\(Y^{\Delta}_{\ell, t} = (Y_{\ell, t}- Y_{\ell, t-7})\ /\ (Y_{\ell, t-7})\)</span>.
We say location <span class="math inline">\(\ell\)</span> is a hotspot at time <span class="math inline">\(t\)</span> when <span class="math inline">\(Z_{\ell,t}\)</span> is
<code>up</code>, meaning the number of newly reported cases over the past 7 days has
increased by at least 25% compared to the preceding week. When <span class="math inline">\(Z_{\ell,t}\)</span>
is categorized as <code>down</code>, it suggests that there has been at least a 20%
decrease in newly reported cases over the past 7 days (a 20% decrease is the inverse of a 25% increase). Otherwise, we will
consider the trend to be <code>flat</code>.</p>
<p>The expression of the multinomial regression we will use is as follows:
<span class="math display">\[
\pi_{j}(x) = \text{Pr}(Z_{\ell,t} = j|x) = \frac{e^{g_j(x)}}{1 + \sum_{k=0}^2 g_j(x) }
\]</span>
where <span class="math inline">\(j\)</span> is either down, flat, or up</p>
<span class="math display">\[\begin{aligned}
g_{\text{down}}(x) &amp;= 0.\\
g_{\text{flat}}(x)&amp;= \text{ln}\left(\frac{Pr(Z_{\ell,t}=\text{flat}|x)}{Pr(Z_{\ell,t}=\text{down}|x)}\right) =
\beta_{10} + \beta_{11}t + \delta_{10} s_{\text{state_1}} +
\delta_{11} s_{\text{state_2}} + \cdots \nonumber \\
&amp;\quad + \beta_{12} Y^{\Delta}_{\ell, t} +
\beta_{13} Y^{\Delta}_{\ell, t-7} \\
g_{\text{flat}}(x) &amp;= \text{ln}\left(\frac{Pr(Z_{\ell,t}=\text{up}|x)}{Pr(Z_{\ell,t}=\text{down}|x)}\right) =
\beta_{20} + \beta_{21}t + \delta_{20} s_{\text{state_1}} +
\delta_{21} s_{\text{state}_2} + \cdots \nonumber \\
&amp;\quad + \beta_{22} Y^{\Delta}_{\ell, t} +
\beta_{23} Y^{\Delta}_{\ell, t-7}
\end{aligned}\]</span>
<p>Preprocessing steps are similar to the previous models with an additional step
of categorizing the response variables. Again, we will use a subset of death rate and case rate data from our built-in dataset
<code>case_death_rate_subset</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jhu</span> <span class="op">&lt;-</span> <span class="va">case_death_rate_subset</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">&gt;=</span> <span class="st">"2021-06-04"</span>, </span>
<span>                <span class="va">time_value</span> <span class="op">&lt;=</span> <span class="st">"2021-12-31"</span>,</span>
<span>  <span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ca"</span>,<span class="st">"fl"</span>,<span class="st">"tx"</span>,<span class="st">"ny"</span>,<span class="st">"nj"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>geo_value_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/as_epi_df.html">as_epi_df</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">jhu</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html">add_role</a></span><span class="op">(</span><span class="va">time_value</span>, new_role <span class="op">=</span> <span class="st">"predictor"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html">step_dummy</a></span><span class="op">(</span><span class="va">geo_value_factor</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">case_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">case_rate</span>, ahead <span class="op">=</span> <span class="fl">7</span>, role <span class="op">=</span> <span class="st">"predictor"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html">step_mutate</a></span><span class="op">(</span></span>
<span>    pct_diff_ahead <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">lag_7_case_rate</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="op">(</span><span class="va">ahead_7_case_rate</span> <span class="op">-</span> <span class="va">lag_0_case_rate</span><span class="op">)</span> <span class="op">/</span> <span class="va">lag_0_case_rate</span><span class="op">)</span>,</span>
<span>    pct_diff_wk1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">lag_7_case_rate</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0</span>, </span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="op">(</span><span class="va">lag_0_case_rate</span> <span class="op">-</span> <span class="va">lag_7_case_rate</span><span class="op">)</span> <span class="op">/</span> <span class="va">lag_7_case_rate</span><span class="op">)</span>,</span>
<span>    pct_diff_wk2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">lag_14_case_rate</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="op">(</span><span class="va">lag_7_case_rate</span> <span class="op">-</span> <span class="va">lag_14_case_rate</span><span class="op">)</span> <span class="op">/</span> <span class="va">lag_14_case_rate</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html">step_mutate</a></span><span class="op">(</span></span>
<span>    response <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">pct_diff_ahead</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.20</span> <span class="op">~</span> <span class="st">"down"</span>,</span>
<span>      <span class="va">pct_diff_ahead</span> <span class="op">&gt;</span> <span class="fl">0.25</span> <span class="op">~</span> <span class="st">"up"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"flat"</span><span class="op">)</span>, </span>
<span>    role <span class="op">=</span> <span class="st">"outcome"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_rm.html">step_rm</a></span><span class="op">(</span><span class="va">death_rate</span>, <span class="va">case_rate</span>, <span class="va">lag_0_case_rate</span>,  <span class="va">lag_7_case_rate</span>, </span>
<span>          <span class="va">lag_14_case_rate</span>, <span class="va">ahead_7_case_rate</span>, <span class="va">pct_diff_ahead</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_naomit.html">step_epi_naomit</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We will fit the multinomial regression and examine the predictions:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/multinom_reg.html">multinom_reg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="va">jhu</span><span class="op">)</span></span>
<span></span>
<span><span class="va">latest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/get_test_data.html">get_test_data</a></span><span class="op">(</span>recipe <span class="op">=</span> <span class="va">r</span>, x <span class="op">=</span> <span class="va">jhu</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">wf</span>, <span class="va">latest</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.pred_class</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 5 x 3 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2022-05-31 12:08:25</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; # A tibble: 5 × 3</span></span>
<span><span class="co">#&gt;   geo_value time_value .pred_class</span></span>
<span><span class="co">#&gt; * &lt;chr&gt;     &lt;date&gt;     &lt;fct&gt;      </span></span>
<span><span class="co">#&gt; 1 ca        2021-12-31 up         </span></span>
<span><span class="co">#&gt; 2 fl        2021-12-31 up         </span></span>
<span><span class="co">#&gt; 3 nj        2021-12-31 up         </span></span>
<span><span class="co">#&gt; 4 ny        2021-12-31 up         </span></span>
<span><span class="co">#&gt; 5 tx        2021-12-31 flat</span></span></code></pre></div>
<p>We can also look at the estimated coefficients and model summary information:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html">extract_fit_engine</a></span><span class="op">(</span><span class="va">wf</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; nnet::multinom(formula = ..y ~ ., data = data, trace = FALSE)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;      (Intercept)   time_value geo_value_factor_fl</span></span>
<span><span class="co">#&gt; flat   -58.11177  0.003162471          -0.5978151</span></span>
<span><span class="co">#&gt; up      46.45080 -0.002429847          -0.4682080</span></span>
<span><span class="co">#&gt;      geo_value_factor_nj geo_value_factor_ny</span></span>
<span><span class="co">#&gt; flat            1.350320            3.113677</span></span>
<span><span class="co">#&gt; up              1.572085            3.172692</span></span>
<span><span class="co">#&gt;      geo_value_factor_tx pct_diff_wk1 pct_diff_wk2</span></span>
<span><span class="co">#&gt; flat          -0.3010305     1.263089     3.610543</span></span>
<span><span class="co">#&gt; up            -0.2505232     2.194646     4.266267</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual Deviance: 1529.929 </span></span>
<span><span class="co">#&gt; AIC: 1561.929</span></span></code></pre></div>
<p>One could also use a formula in <code><a href="https://cmu-delphi.github.io/epipredict/reference/epi_recipe.html">epi_recipe()</a></code> to achieve the same results as
above. However, only one of <code><a href="https://workflows.tidymodels.org/reference/add_formula.html">add_formula()</a></code>, <code><a href="https://workflows.tidymodels.org/reference/add_recipe.html">add_recipe()</a></code>, or
<code><a href="https://workflows.tidymodels.org/reference/add_variables.html">workflow_variables()</a></code> can be specified. For the purpose of demonstrating
<code>add_formula</code> rather than <code>add_recipe</code>, we will <code>prep</code> and <code>bake</code> our recipe to
return a <code>data.frame</code> that could be used for model fitting.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html">bake</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html">prep</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">jhu</span><span class="op">)</span>, <span class="va">jhu</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_formula.html">add_formula</a></span><span class="op">(</span><span class="va">response</span> <span class="op">~</span> <span class="va">geo_value</span> <span class="op">+</span> <span class="va">time_value</span> <span class="op">+</span> <span class="va">pct_diff_wk1</span> <span class="op">+</span> <span class="va">pct_diff_wk2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_model.html">add_model</a></span><span class="op">(</span><span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/multinom_reg.html">multinom_reg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">b</span><span class="op">)</span></span>
<span><span class="co">#&gt; ══ Workflow [trained] ═════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; Preprocessor: Formula</span></span>
<span><span class="co">#&gt; Model: multinom_reg()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; response ~ geo_value + time_value + pct_diff_wk1 + pct_diff_wk2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; nnet::multinom(formula = ..y ~ ., data = data, trace = FALSE)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;      (Intercept) geo_valuefl geo_valuenj geo_valueny</span></span>
<span><span class="co">#&gt; flat   -58.11158  -0.5978159    1.350325    3.113684</span></span>
<span><span class="co">#&gt; up      46.45071  -0.4682087    1.572090    3.172698</span></span>
<span><span class="co">#&gt;      geo_valuetx   time_value pct_diff_wk1 pct_diff_wk2</span></span>
<span><span class="co">#&gt; flat  -0.3010308  0.003162461     1.263093     3.610536</span></span>
<span><span class="co">#&gt; up    -0.2505236 -0.002429839     2.194649     4.266259</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual Deviance: 1529.929 </span></span>
<span><span class="co">#&gt; AIC: 1561.929</span></span></code></pre></div>
</div>
<div id="benefits-of-lagging-and-leading-in-epipredict" class="section level2" number="3.5">
<h2>
<span class="header-section-number">3.5</span> Benefits of Lagging and Leading in <code>epipredict</code><a class="anchor" aria-label="anchor" href="#benefits-of-lagging-and-leading-in-epipredict"><i class="fas fa-link"></i></a>
</h2>
<p>The <code>step_epi_ahead</code> and <code>step_epi_lag</code> functions in the <code>epipredict</code> package
is handy for creating correct lags and leads for future predictions.</p>
<p>Let’s start with a simple dataset and preprocessing:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>  <span class="va">case_death_rate_subset</span>, </span>
<span>  <span class="va">time_value</span> <span class="op">&gt;=</span> <span class="st">"2021-12-01"</span>, </span>
<span>  <span class="va">time_value</span> <span class="op">&lt;=</span> <span class="st">"2021-12-31"</span>,</span>
<span>  <span class="va">geo_value</span> <span class="op">==</span> <span class="st">"ca"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 31  4</span></span></code></pre></div>
<p>We want to predict death rates on 2022-01-07, which is 7 days ahead of the
latest available date in our dataset.</p>
<p>We will compare two methods of trying to create lags and leads:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">case_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">death_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">death_rate</span>, ahead <span class="op">=</span> <span class="fl">7</span>, role <span class="op">=</span> <span class="st">"outcome"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_naomit.html">step_epi_naomit</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html">prep</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html">bake</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">ex</span><span class="op">)</span></span>
<span><span class="va">b1</span></span>
<span><span class="co">#&gt; # A tibble: 17 × 11</span></span>
<span><span class="co">#&gt;    time_value geo_value case_rate death_rate lag_0_case_rate</span></span>
<span><span class="co">#&gt;    &lt;date&gt;     &lt;chr&gt;         &lt;dbl&gt;      &lt;dbl&gt;           &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 2021-12-15 ca             15.8      0.157            15.8</span></span>
<span><span class="co">#&gt;  2 2021-12-16 ca             16.3      0.155            16.3</span></span>
<span><span class="co">#&gt;  3 2021-12-17 ca             16.9      0.158            16.9</span></span>
<span><span class="co">#&gt;  4 2021-12-18 ca             17.6      0.164            17.6</span></span>
<span><span class="co">#&gt;  5 2021-12-19 ca             19.1      0.165            19.1</span></span>
<span><span class="co">#&gt;  6 2021-12-20 ca             20.6      0.164            20.6</span></span>
<span><span class="co">#&gt;  7 2021-12-21 ca             22.6      0.165            22.6</span></span>
<span><span class="co">#&gt;  8 2021-12-22 ca             26.2      0.163            26.2</span></span>
<span><span class="co">#&gt;  9 2021-12-23 ca             30.8      0.167            30.8</span></span>
<span><span class="co">#&gt; 10 2021-12-24 ca             33.8      0.167            33.8</span></span>
<span><span class="co">#&gt; 11 2021-12-25 ca             32.6      0.153            32.6</span></span>
<span><span class="co">#&gt; 12 2021-12-26 ca             34.5      0.153            34.5</span></span>
<span><span class="co">#&gt; 13 2021-12-27 ca             48.4      0.132            48.4</span></span>
<span><span class="co">#&gt; 14 2021-12-28 ca             54.9      0.142            54.9</span></span>
<span><span class="co">#&gt; 15 2021-12-29 ca             63.7      0.140            63.7</span></span>
<span><span class="co">#&gt; 16 2021-12-30 ca             76.0      0.140            76.0</span></span>
<span><span class="co">#&gt; 17 2021-12-31 ca             84.4      0.142            84.4</span></span>
<span><span class="co">#&gt; # ℹ 6 more variables: lag_7_case_rate &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   lag_14_case_rate &lt;dbl&gt;, lag_0_death_rate &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   lag_7_death_rate &lt;dbl&gt;, lag_14_death_rate &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   ahead_7_death_rate &lt;dbl&gt;</span></span>
<span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html">step_mutate</a></span><span class="op">(</span>lag0case_rate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">case_rate</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>              lag7case_rate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">case_rate</span>, <span class="fl">7</span><span class="op">)</span>,</span>
<span>              lag14case_rate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">case_rate</span>, <span class="fl">14</span><span class="op">)</span>,</span>
<span>              lag0death_rate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">death_rate</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>              lag7death_rate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">death_rate</span>, <span class="fl">7</span><span class="op">)</span>,</span>
<span>              lag14death_rate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">death_rate</span>, <span class="fl">14</span><span class="op">)</span>,</span>
<span>              ahead7death_rate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lead</a></span><span class="op">(</span><span class="va">death_rate</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/step_epi_naomit.html">step_epi_naomit</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html">prep</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html">bake</a></span><span class="op">(</span><span class="va">p2</span>, <span class="va">ex</span><span class="op">)</span></span>
<span><span class="va">b2</span></span>
<span><span class="co">#&gt; # A tibble: 10 × 11</span></span>
<span><span class="co">#&gt;    time_value geo_value case_rate death_rate lag0case_rate</span></span>
<span><span class="co">#&gt;    &lt;date&gt;     &lt;chr&gt;         &lt;dbl&gt;      &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 2021-12-15 ca             15.8      0.157          15.8</span></span>
<span><span class="co">#&gt;  2 2021-12-16 ca             16.3      0.155          16.3</span></span>
<span><span class="co">#&gt;  3 2021-12-17 ca             16.9      0.158          16.9</span></span>
<span><span class="co">#&gt;  4 2021-12-18 ca             17.6      0.164          17.6</span></span>
<span><span class="co">#&gt;  5 2021-12-19 ca             19.1      0.165          19.1</span></span>
<span><span class="co">#&gt;  6 2021-12-20 ca             20.6      0.164          20.6</span></span>
<span><span class="co">#&gt;  7 2021-12-21 ca             22.6      0.165          22.6</span></span>
<span><span class="co">#&gt;  8 2021-12-22 ca             26.2      0.163          26.2</span></span>
<span><span class="co">#&gt;  9 2021-12-23 ca             30.8      0.167          30.8</span></span>
<span><span class="co">#&gt; 10 2021-12-24 ca             33.8      0.167          33.8</span></span>
<span><span class="co">#&gt; # ℹ 6 more variables: lag7case_rate &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   lag14case_rate &lt;dbl&gt;, lag0death_rate &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   lag7death_rate &lt;dbl&gt;, lag14death_rate &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   ahead7death_rate &lt;dbl&gt;</span></span></code></pre></div>
<p>Notice the difference in number of rows <code>b1</code> and <code>b2</code> returns. This is because
the second version, the one that doesn’t use <code>step_epi_ahead</code> and <code>step_epi_lag</code>,
has omitted dates compared to the one that used the <code>epipredict</code> functions.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dates_used_in_training1</span> <span class="op">&lt;-</span> <span class="va">b1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span> <span class="va">ahead_7_death_rate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span></span>
<span><span class="va">dates_used_in_training1</span></span>
<span><span class="co">#&gt; # A tibble: 17 × 1</span></span>
<span><span class="co">#&gt;    time_value</span></span>
<span><span class="co">#&gt;    &lt;date&gt;    </span></span>
<span><span class="co">#&gt;  1 2021-12-15</span></span>
<span><span class="co">#&gt;  2 2021-12-16</span></span>
<span><span class="co">#&gt;  3 2021-12-17</span></span>
<span><span class="co">#&gt;  4 2021-12-18</span></span>
<span><span class="co">#&gt;  5 2021-12-19</span></span>
<span><span class="co">#&gt;  6 2021-12-20</span></span>
<span><span class="co">#&gt;  7 2021-12-21</span></span>
<span><span class="co">#&gt;  8 2021-12-22</span></span>
<span><span class="co">#&gt;  9 2021-12-23</span></span>
<span><span class="co">#&gt; 10 2021-12-24</span></span>
<span><span class="co">#&gt; 11 2021-12-25</span></span>
<span><span class="co">#&gt; 12 2021-12-26</span></span>
<span><span class="co">#&gt; 13 2021-12-27</span></span>
<span><span class="co">#&gt; 14 2021-12-28</span></span>
<span><span class="co">#&gt; 15 2021-12-29</span></span>
<span><span class="co">#&gt; 16 2021-12-30</span></span>
<span><span class="co">#&gt; 17 2021-12-31</span></span>
<span></span>
<span><span class="va">dates_used_in_training2</span> <span class="op">&lt;-</span> <span class="va">b2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span> <span class="va">ahead7death_rate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span></span>
<span><span class="va">dates_used_in_training2</span></span>
<span><span class="co">#&gt; # A tibble: 10 × 1</span></span>
<span><span class="co">#&gt;    time_value</span></span>
<span><span class="co">#&gt;    &lt;date&gt;    </span></span>
<span><span class="co">#&gt;  1 2021-12-15</span></span>
<span><span class="co">#&gt;  2 2021-12-16</span></span>
<span><span class="co">#&gt;  3 2021-12-17</span></span>
<span><span class="co">#&gt;  4 2021-12-18</span></span>
<span><span class="co">#&gt;  5 2021-12-19</span></span>
<span><span class="co">#&gt;  6 2021-12-20</span></span>
<span><span class="co">#&gt;  7 2021-12-21</span></span>
<span><span class="co">#&gt;  8 2021-12-22</span></span>
<span><span class="co">#&gt;  9 2021-12-23</span></span>
<span><span class="co">#&gt; 10 2021-12-24</span></span></code></pre></div>
<p>The model that is trained based on the <a href="https://github.com/tidymodels/recipes">recipes</a> functions will predict 7 days ahead from
2021-12-24
instead of 7 days ahead from 2021-12-31.</p>
</div>
<div id="references" class="section level2" number="3.6">
<h2>
<span class="header-section-number">3.6</span> References<a class="anchor" aria-label="anchor" href="#references"><i class="fas fa-link"></i></a>
</h2>
<p>McDonald, Bien, Green, Hu, et al. “Can auxiliary indicators improve COVID-19
forecasting and hotspot prediction?.” Proceedings of the National Academy of
Sciences 118.51 (2021): e2111453118. <a href="https://doi.org/10.1073/pnas.2111453118">doi:10.1073/pnas.2111453118</a></p>
</div>
<div id="attribution-1" class="section level2" number="3.7">
<h2>
<span class="header-section-number">3.7</span> Attribution<a class="anchor" aria-label="anchor" href="#attribution-1"><i class="fas fa-link"></i></a>
</h2>
<p>This vignette contains a modified part of the <a href="https://github.com/CSSEGISandData/COVID-19">COVID-19 Data Repository by the
Center for Systems Science and Engineering (CSSE) at Johns Hopkins
University</a> as <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/jhu-csse.html">republished in the
COVIDcast Epidata
API.</a>.
See the COVIDcast Epidata API documentation for its modifications, and the code
above for further modifications. This data set is licensed under the terms of
the <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International
license</a> by the Johns Hopkins
University on behalf of its Center for Systems Science in Engineering. Copyright
Johns Hopkins University 2020.</p>

</div>
</div>







  <div class="chapter-nav">
<div class="empty"></div>
<div class="empty"></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <div id="book-on-this-page"></div>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Vignette on Delphi Tooling for CDPH</strong>" was written by Logan Brooks, Daniel J. McDonald, and Ryan J. Tibshirani. It was last built on 2023-04-08.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
