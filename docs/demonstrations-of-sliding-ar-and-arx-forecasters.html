<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 2 Demonstrations of sliding AR and ARX forecasters | Vignette on Delphi Tooling for CDPH</title>
<meta name="author" content="Logan C. Brooks, Daniel J. McDonald, and Ryan J. Tibshirani">
<meta name="description" content="library(epipredict) library(epiprocess) library(magrittr) library(dplyr) library(tidyr) library(data.table) library(parsnip) library(ggplot2) A key function from the epiprocess package is...">
<meta name="generator" content="bookdown 0.33 with bs4_book()">
<meta property="og:title" content="Chapter 2 Demonstrations of sliding AR and ARX forecasters | Vignette on Delphi Tooling for CDPH">
<meta property="og:type" content="book">
<meta property="og:url" content="https://delphi.cmu.edu/demonstrations-of-sliding-ar-and-arx-forecasters.html">
<meta property="og:description" content="library(epipredict) library(epiprocess) library(magrittr) library(dplyr) library(tidyr) library(data.table) library(parsnip) library(ggplot2) A key function from the epiprocess package is...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 2 Demonstrations of sliding AR and ARX forecasters | Vignette on Delphi Tooling for CDPH">
<meta name="twitter:description" content="library(epipredict) library(epiprocess) library(magrittr) library(dplyr) library(tidyr) library(data.table) library(parsnip) library(ggplot2) A key function from the epiprocess package is...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Vignette on Delphi Tooling for CDPH</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="active" href="demonstrations-of-sliding-ar-and-arx-forecasters.html"><span class="header-section-number">2</span> Demonstrations of sliding AR and ARX forecasters</a></li>
<li><a class="" href="examples-of-preprocessing-and-models.html"><span class="header-section-number">3</span> Examples of Preprocessing and Models</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/dajmcdon/cdph-vignette">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="demonstrations-of-sliding-ar-and-arx-forecasters" class="section level1" number="2">
<h1>
<span class="header-section-number">2</span> Demonstrations of sliding AR and ARX forecasters<a class="anchor" aria-label="anchor" href="#demonstrations-of-sliding-ar-and-arx-forecasters"><i class="fas fa-link"></i></a>
</h1>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epipredict/">epipredict</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epiprocess/">epiprocess</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://Rdatatable.gitlab.io/data.table">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/parsnip">parsnip</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>A key function from the epiprocess package is <code><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_slide.html">epi_slide()</a></code>, which allows the
user to apply a function or formula-based computation over variables in an
<code>epi_df</code> over a running window of <code>n</code> time steps (see the following <code>epiprocess</code>
vignette to go over the basics of the function: <a href="https://cmu-delphi.github.io/epiprocess/articles/slide.html">“Slide a computation over
signal values”</a>).
The equivalent sliding method for an <code>epi_archive</code> object can be called by using
the wrapper function <code><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html">epix_slide()</a></code> (refer to the following vignette for the
basics of the function: <a href="https://cmu-delphi.github.io/epiprocess/articles/archive.html">“Work with archive objects and data
revisions”</a>). The
key difference from <code><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_slide.html">epi_slide()</a></code> is that it performs version-aware
computations. That is, the function only uses data that would have been
available as of time t for that reference time.</p>
<p>In this vignette, we use <code><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_slide.html">epi_slide()</a></code> and <code><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html">epix_slide()</a></code> for backtesting our
<code>arx_forecaster</code> on historical COVID-19 case data from the US and from Canada.
More precisely, we first demonstrate using <code><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_slide.html">epi_slide()</a></code> to slide ARX
forecasters over an <code>epi_df</code> object and compare the results obtained from using
different forecasting engines. We then compare these simple retrospective
forecasts to more proper “pseudoprospective” forecasts generated using snapshots
of the data that was available in real time, using <code><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html">epix_slide()</a></code>.</p>
<div id="comparing-different-forecasting-engines" class="section level2" number="2.1">
<h2>
<span class="header-section-number">2.1</span> Comparing different forecasting engines<a class="anchor" aria-label="anchor" href="#comparing-different-forecasting-engines"><i class="fas fa-link"></i></a>
</h2>
<div id="example-using-cli-and-case-data-from-us-states" class="section level3" number="2.1.1">
<h3>
<span class="header-section-number">2.1.1</span> Example using CLI and case data from US states<a class="anchor" aria-label="anchor" href="#example-using-cli-and-case-data-from-us-states"><i class="fas fa-link"></i></a>
</h3>
<p>First, we download the version history (i.e. archive) of the percentage of
doctor’s visits with CLI (COVID-like illness) computed from medical insurance
claims and the number of new confirmed COVID-19 cases per 100,000 population
(daily) for all 50 states from the COVIDcast API. We process as before, with the
modification that we use <code>sync = "locf"</code> in <code><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_merge.html">epix_merge()</a></code> so that the last
version of each observation can be carried forward to extrapolate unavailable
versions for the less up-to-date input archive.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_raw_history_dfs</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"all_states_covidcast_signals.rds"</span>,</span>
<span>                      package <span class="op">=</span> <span class="st">"epipredict"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_cli_archive</span> <span class="op">&lt;-</span> <span class="va">us_raw_history_dfs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, version <span class="op">=</span> <span class="va">issue</span>, percent_cli <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/as_epi_archive.html">as_epi_archive</a></span><span class="op">(</span>compactify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">us_cases_archive</span> <span class="op">&lt;-</span> <span class="va">us_raw_history_dfs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, version <span class="op">=</span> <span class="va">issue</span>, case_rate <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/as_epi_archive.html">as_epi_archive</a></span><span class="op">(</span>compactify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">us_archive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_merge.html">epix_merge</a></span><span class="op">(</span><span class="va">us_cli_archive</span>, <span class="va">us_cases_archive</span>,</span>
<span>                      sync <span class="op">=</span> <span class="st">"locf"</span>, compactify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>After obtaining the latest snapshot of the data, we produce forecasts on that
data using the default engine of simple linear regression and compare to a
random forest.</p>
<p>Note that all of the warnings about the forecast date being less than the most
recent update date of the data have been suppressed to avoid cluttering the
output.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Latest snapshot of data, and forecast dates</span></span>
<span><span class="va">us_latest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html">epix_as_of</a></span><span class="op">(</span><span class="va">us_archive</span>, max_version <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">us_archive</span><span class="op">$</span><span class="va">versions_end</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">fc_time_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2020-08-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-01"</span><span class="op">)</span>, </span>
<span>                      by <span class="op">=</span> <span class="st">"1 month"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">k_week_ahead</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">epi_df</span>, <span class="va">outcome</span>, <span class="va">predictors</span>, <span class="va">ahead</span> <span class="op">=</span> <span class="fl">7</span>, <span class="va">engine</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">epi_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_slide.html">epi_slide</a></span><span class="op">(</span> </span>
<span>      <span class="op">~</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>        <span class="va">.x</span>, <span class="va">outcome</span>, <span class="va">predictors</span>, <span class="va">engine</span>, </span>
<span>        args_list <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span>ahead <span class="op">=</span> <span class="va">ahead</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">extract2</a></span><span class="op">(</span><span class="st">"predictions"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, </span>
<span>      n <span class="op">=</span> <span class="fl">120</span>, </span>
<span>      ref_time_values <span class="op">=</span> <span class="va">fc_time_values</span>, </span>
<span>      new_col_name <span class="op">=</span> <span class="st">"fc"</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"fc"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>engine_type <span class="op">=</span> <span class="va">engine</span><span class="op">$</span><span class="va">engine</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Generate the forecasts and bind them together</span></span>
<span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_dfr</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>,<span class="fl">14</span>,<span class="fl">21</span>,<span class="fl">28</span><span class="op">)</span>, </span>
<span>    <span class="op">~</span> <span class="fu">k_week_ahead</span><span class="op">(</span></span>
<span>      <span class="va">us_latest</span>, <span class="st">"case_rate"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"case_rate"</span>, <span class="st">"percent_cli"</span><span class="op">)</span>, <span class="va">.x</span>,</span>
<span>      engine <span class="op">=</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html">linear_reg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_dfr</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>,<span class="fl">14</span>,<span class="fl">21</span>,<span class="fl">28</span><span class="op">)</span>, </span>
<span>    <span class="op">~</span> <span class="fu">k_week_ahead</span><span class="op">(</span></span>
<span>      <span class="va">us_latest</span>, <span class="st">"case_rate"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"case_rate"</span>, <span class="st">"percent_cli"</span><span class="op">)</span>, <span class="va">.x</span>,</span>
<span>      engine <span class="op">=</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/rand_forest.html">rand_forest</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"regression"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.pred_distn <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/nested_quantiles.html">nested_quantiles</a></span><span class="op">(</span><span class="va">fc_.pred_distn</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span><span class="op">(</span><span class="va">.pred_distn</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">tau</span>, values_from <span class="op">=</span> <span class="va">q</span><span class="op">)</span> </span></code></pre></div>
<p>Here, <code><a href="https://cmu-delphi.github.io/epipredict/reference/arx_forecaster.html">arx_forecaster()</a></code> does all the heavy lifting. It creates leads of the
target (respecting time stamps and locations) along with lags of the features
(here, the response and doctors visits), estimates a forecasting model using the
specified engine, creates predictions, and non-parametric confidence bands.</p>
<p>To see how the predictions compare, we plot them on top of the latest case
rates. Note that even though we’ve fitted the model on all states,
we’ll just display the
results for two states, California (CA) and Florida (FL), to get a sense of the
model performance while keeping the graphic simple.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fc_cafl</span> <span class="op">&lt;-</span> <span class="va">fc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ca"</span>, <span class="st">"fl"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">latest_cafl</span> <span class="op">&lt;-</span> <span class="va">us_latest</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ca"</span>, <span class="st">"fl"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">fc_cafl</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">fc_target_date</span>, group <span class="op">=</span> <span class="va">time_value</span>, fill <span class="op">=</span> <span class="va">engine_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">latest_cafl</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">case_rate</span><span class="op">)</span>,</span>
<span>            inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"gray50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">`0.05`</span>, ymax <span class="op">=</span> <span class="va">`0.95`</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">fc_.pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">fc_.pred</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">engine_type</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 case rates"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="01-sliding_files/figure-html/plot-arx-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>For the two states of interest, simple linear regression clearly performs better
than random forest in terms of accuracy of the predictions and does not
result in such in overconfident predictions (overly narrow confidence bands).
Though, in general, neither approach produces amazingly accurate forecasts.
This could be because
the behaviour is rather different across states and the effects of other notable
factors such as age and public health measures may be important to account for
in such forecasting. Including such factors as well as making enhancements such
as correcting for outliers are some improvements one could make to this simple
model.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Note that, despite the above caveats, simple models like this tend to out-perform many far more complicated models in the online Covid forecasting due to those models high variance predictions.&lt;/p&gt;"><sup>2</sup></a></p>
</div>
<div id="example-using-case-data-from-canada" class="section level3" number="2.1.2">
<h3>
<span class="header-section-number">2.1.2</span> Example using case data from Canada<a class="anchor" aria-label="anchor" href="#example-using-case-data-from-canada"><i class="fas fa-link"></i></a>
</h3>
<p>By leveraging the flexibility of <code>epiprocess</code>, we can apply the same techniques
to data from other sources. Since some collaborators are in British Columbia,
Canada, we’ll do essentially the same thing for Canada as we did above.</p>
<p>The <a href="https://opencovid.ca/">COVID-19 Canada Open Data Working Group</a> collects
daily time series data on COVID-19 cases, deaths, recoveries, testing and
vaccinations at the health region and province levels. Data are collected from
publicly available sources such as government datasets and news releases.
Unfortunately, there is no simple versioned source, so we have created our own
from the Github commit history.</p>
<p>First, we load versioned case rates at the provincial level. After converting
these to 7-day averages (due to highly variable provincial reporting
mismatches), we then convert the data to an <code>epi_archive</code> object, and extract
the latest version from it. Finally, we run the same forcasting exercise as for
the American data, but here we compare the forecasts produced from using simple
linear regression with those from using boosted regression trees.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># source("drafts/canada-case-rates.R)</span></span>
<span><span class="va">can</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"can_prov_cases.rds"</span>, </span>
<span>              package <span class="op">=</span> <span class="st">"epipredict"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">version</span>, <span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cr_7dav <span class="op">=</span> <span class="fu">RcppRoll</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RcppRoll/man/RcppRoll-exports.html">roll_meanr</a></span><span class="op">(</span><span class="va">case_rate</span>, n <span class="op">=</span> <span class="fl">7L</span><span class="op">)</span><span class="op">)</span> <span class="co">#%&gt;%</span></span>
<span>  <span class="co">#filter(geo_value %in% c('Alberta', "BC"))</span></span>
<span><span class="va">can</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/as_epi_archive.html">as_epi_archive</a></span><span class="op">(</span><span class="va">can</span>, compactify<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">can_latest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html">epix_as_of</a></span><span class="op">(</span><span class="va">can</span>, max_version <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">can</span><span class="op">$</span><span class="va">DT</span><span class="op">$</span><span class="va">version</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Generate the forecasts, and bind them together</span></span>
<span><span class="va">can_fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="fu">purrr</span><span class="fu">:::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_dfr</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>,<span class="fl">14</span>,<span class="fl">21</span>,<span class="fl">28</span><span class="op">)</span>, </span>
<span>    <span class="op">~</span> <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">can_latest</span>, <span class="st">"cr_7dav"</span>, <span class="st">"cr_7dav"</span>, <span class="va">.x</span>, <span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html">linear_reg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_dfr</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>,<span class="fl">14</span>,<span class="fl">21</span>,<span class="fl">28</span><span class="op">)</span>,</span>
<span>    <span class="op">~</span> <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">can_latest</span>, <span class="st">"cr_7dav"</span>, <span class="st">"cr_7dav"</span>, <span class="va">.x</span>, </span>
<span>                   <span class="fu"><a href="https://parsnip.tidymodels.org/reference/boost_tree.html">boost_tree</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"regression"</span>, trees <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.pred_distn <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/nested_quantiles.html">nested_quantiles</a></span><span class="op">(</span><span class="va">fc_.pred_distn</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span><span class="op">(</span><span class="va">.pred_distn</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">tau</span>, values_from <span class="op">=</span> <span class="va">q</span><span class="op">)</span> </span></code></pre></div>
<p>The figures below shows the results for all of the provinces.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">can_fc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">engine_type</span> <span class="op">==</span> <span class="st">"lm"</span><span class="op">)</span>, </span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">fc_target_date</span>, group <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2020-12-01"</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">can_latest</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">cr_7dav</span><span class="op">)</span>,</span>
<span>            inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"gray50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">`0.05`</span>, ymax <span class="op">=</span> <span class="va">`0.95`</span>, fill <span class="op">=</span> <span class="va">geo_value</span><span class="op">)</span>,</span>
<span>              alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">fc_.pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">fc_.pred</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">geo_value</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Using simple linear regression"</span>, x <span class="op">=</span> <span class="st">"Date"</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Reported COVID-19 case rates"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span>  </span></code></pre></div>
<div class="inline-figure"><img src="01-sliding_files/figure-html/plot-can-fc-lr-1.png" width="90%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">can_fc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">engine_type</span> <span class="op">==</span> <span class="st">"xgboost"</span><span class="op">)</span>, </span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">fc_target_date</span>, group <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2020-12-01"</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">can_latest</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">cr_7dav</span><span class="op">)</span>,</span>
<span>            inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"gray50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">`0.05`</span>, ymax <span class="op">=</span> <span class="va">`0.95`</span>, fill <span class="op">=</span> <span class="va">geo_value</span><span class="op">)</span>,</span>
<span>              alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">fc_.pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">fc_.pred</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">geo_value</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Using boosted regression trees"</span>, x <span class="op">=</span> <span class="st">"Date"</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Reported COVID-19 case rates"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span>  </span></code></pre></div>
<div class="inline-figure"><img src="01-sliding_files/figure-html/plot-can-fc-boost-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>Both approaches tend to produce quite volatile forecasts (point predictions)
and/or are overly confident (very narrow bands), particularly when boosted
regression trees are used. But as this is meant to be a simple demonstration of
sliding with different engines in <code>arx_forecaster</code>, we may devote another
vignette to work on improving the predictive modelling using the suite of tools
available in epipredict.</p>
</div>
</div>
<div id="pseudoprospective-vs.-unfaithful-retrospective-forecasting" class="section level2" number="2.2">
<h2>
<span class="header-section-number">2.2</span> Pseudoprospective vs. unfaithful retrospective forecasting<a class="anchor" aria-label="anchor" href="#pseudoprospective-vs.-unfaithful-retrospective-forecasting"><i class="fas fa-link"></i></a>
</h2>
<div id="example-using-case-data-from-us-states" class="section level3" number="2.2.1">
<h3>
<span class="header-section-number">2.2.1</span> Example using case data from US states<a class="anchor" aria-label="anchor" href="#example-using-case-data-from-us-states"><i class="fas fa-link"></i></a>
</h3>
<p>We will now run pseudoprospective forecasts based on properly-versioned data
(that would have been available in real-time) to forecast future COVID-19 case
rates from current and past COVID-19 case rates for all states. That is, we can
make forecasts on the archive, <code>us_archive</code>, and compare those to forecasts on
(time windows of) the latest data, <code>us_latest</code>, using the same general set-up as
above. For pseudoprospective forecasting, note that <code>us_archive</code> is fed into
<code><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html">epix_slide()</a></code>, while for simpler (unfaithful) retrospective forecasting,
<code>us_latest</code> is fed into <code><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_slide.html">epi_slide()</a></code>. #%% update to include percent_cli after
that issue is fixed?</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">k_week_ahead_as_of</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ahead</span> <span class="op">=</span> <span class="fl">7</span>, <span class="va">version_faithful</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">version_faithful</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html">epix_slide</a></span><span class="op">(</span></span>
<span>      <span class="va">us_archive</span>,</span>
<span>      <span class="op">~</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"case_rate"</span>, <span class="st">"case_rate"</span>,</span>
<span>                       args_list <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span>ahead <span class="op">=</span> <span class="va">ahead</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">extract2</a></span><span class="op">(</span><span class="st">"predictions"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      n <span class="op">=</span> <span class="fl">120</span>, </span>
<span>      ref_time_values <span class="op">=</span> <span class="va">fc_time_values</span>, </span>
<span>      new_col_name <span class="op">=</span> <span class="st">"fc"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>engine_type <span class="op">=</span> <span class="st">"lm"</span>, version_faithful <span class="op">=</span> <span class="va">version_faithful</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">us_latest</span>, <span class="st">"case_rate"</span>, <span class="st">"case_rate"</span>, <span class="va">ahead</span>, <span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html">linear_reg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>version_faithful <span class="op">=</span> <span class="va">version_faithful</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Generate the forecasts, and bind them together</span></span>
<span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_dfr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>,<span class="fl">14</span>,<span class="fl">21</span>,<span class="fl">28</span><span class="op">)</span>, <span class="op">~</span> <span class="fu">k_week_ahead_as_of</span><span class="op">(</span><span class="va">.x</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_dfr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>,<span class="fl">14</span>,<span class="fl">21</span>,<span class="fl">28</span><span class="op">)</span>, <span class="op">~</span> <span class="fu">k_week_ahead_as_of</span><span class="op">(</span><span class="va">.x</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.pred_distn <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epipredict/reference/nested_quantiles.html">nested_quantiles</a></span><span class="op">(</span><span class="va">fc_.pred_distn</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span><span class="op">(</span><span class="va">.pred_distn</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">tau</span>, values_from <span class="op">=</span> <span class="va">q</span><span class="op">)</span> </span></code></pre></div>
<p>Now we can plot the results on top of the latest case rates. As before, we will only display and focus on the results for FL and CA for simplicity.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fc_cafl</span> <span class="op">=</span> <span class="va">fc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ca"</span>, <span class="st">"fl"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">latest_cafl</span> <span class="op">=</span> <span class="va">us_latest</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ca"</span>, <span class="st">"fl"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">fc_cafl</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">fc_target_date</span>, group <span class="op">=</span> <span class="va">time_value</span>, fill <span class="op">=</span> <span class="va">version_faithful</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">latest_cafl</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">case_rate</span><span class="op">)</span>,</span>
<span>            inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"gray50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">`0.05`</span>, ymax <span class="op">=</span> <span class="va">`0.95`</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">fc_.pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">fc_.pred</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">~</span> <span class="va">version_faithful</span>, scales <span class="op">=</span> <span class="st">"free"</span>, </span>
<span>             labeller <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labeller.html">labeller</a></span><span class="op">(</span>version_faithful <span class="op">=</span> <span class="va">label_both</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 case rates"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="01-sliding_files/figure-html/plot-ar-asof-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>Again, we observe that the results are not great for these two states, but
that’s likely due to the simplicity of the model (ex. the omission of key
factors such as age and public health measures) and the quality of the data (ex.
we have not personally corrected for anomalies in the data).</p>
<p>We shall leave it to the reader to try the above version aware and unaware
forecasting exercise on the Canadian case rate data. The above code for the
American state data should be readily adaptable for this purpose.</p>
</div>
</div>
<div id="attribution" class="section level2" number="2.3">
<h2>
<span class="header-section-number">2.3</span> Attribution<a class="anchor" aria-label="anchor" href="#attribution"><i class="fas fa-link"></i></a>
</h2>
<p>This object contains a modified part of the COVID-19 Data Repository by the
Center for Systems Science and Engineering (CSSE) at Johns Hopkins University as
republished in the COVIDcast Epidata API. This data set is licensed under the
terms of the Creative Commons Attribution 4.0 International license by Johns
Hopkins University on behalf of its Center for Systems Science in Engineering.
Copyright Johns Hopkins University 2020.</p>
<p>Modifications:</p>
<ul>
<li>From the COVIDcast Doctor Visits API: The signal
<code>percent_cli</code> is taken directly from the API without changes.</li>
<li>From the COVIDcast Epidata API: <code>case_rate_7d_av</code> signal was computed by
Delphi from the original JHU-CSSE data by calculating moving averages of the
preceding 7 days, so the signal for June 7 is the average of the underlying
data for June 1 through 7, inclusive.</li>
<li>Other modifications shown in code above.</li>
</ul>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="index.html"><span class="header-section-number">1</span> Introduction</a></div>
<div class="next"><a href="examples-of-preprocessing-and-models.html"><span class="header-section-number">3</span> Examples of Preprocessing and Models</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#demonstrations-of-sliding-ar-and-arx-forecasters"><span class="header-section-number">2</span> Demonstrations of sliding AR and ARX forecasters</a></li>
<li>
<a class="nav-link" href="#comparing-different-forecasting-engines"><span class="header-section-number">2.1</span> Comparing different forecasting engines</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#example-using-cli-and-case-data-from-us-states"><span class="header-section-number">2.1.1</span> Example using CLI and case data from US states</a></li>
<li><a class="nav-link" href="#example-using-case-data-from-canada"><span class="header-section-number">2.1.2</span> Example using case data from Canada</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#pseudoprospective-vs.-unfaithful-retrospective-forecasting"><span class="header-section-number">2.2</span> Pseudoprospective vs. unfaithful retrospective forecasting</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#example-using-case-data-from-us-states"><span class="header-section-number">2.2.1</span> Example using case data from US states</a></li></ul>
</li>
<li><a class="nav-link" href="#attribution"><span class="header-section-number">2.3</span> Attribution</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/dajmcdon/cdph-vignette/blob/master/01-sliding.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/dajmcdon/cdph-vignette/edit/master/01-sliding.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Vignette on Delphi Tooling for CDPH</strong>" was written by Logan C. Brooks, Daniel J. McDonald, and Ryan J. Tibshirani. It was last built on 2023-04-10.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
